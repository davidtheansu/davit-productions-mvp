import type { NextApiRequest, NextApiResponse } from 'next'; import { getEvent, updateClock } from '@/lib/db'; export default function handler(req:NextApiRequest,res:NextApiResponse){ if(req.method!=='POST') return res.status(405).json({error:'method'}); const { slug,kind,token } = req.body||{}; if(!slug||!kind||!token) return res.status(400).json({error:'missing'}); const e=getEvent(String(slug)); if(!e) return res.status(404).json({error:'event'}); const ref=(e as any).roles['refRemote']; if(!ref||ref.token!==token) return res.status(401).json({error:'unauthorized'}); if(kind==='toggle'){ const running=!e.clock.running; updateClock(e.slug,{running}); return res.json({ok:true,action:'toggle',running}); } if(kind==='timeout'){ return res.json({ok:true,action:'timeout'}); } if(kind==='replayMark'){ return res.json({ok:true,action:'replayMark'}); } return res.status(400).json({error:'unknown kind'}); }
